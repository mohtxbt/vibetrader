{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS"
  },
  "deploy": {
    "numReplicas": 1,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  },
  "services": {
    "api": {
      "source": {
        "repo": null
      },
      "build": {
        "builder": "NIXPACKS",
        "buildCommand": "pnpm install && pnpm --filter api build",
        "watchPatterns": ["apps/api/**", "packages/**"]
      },
      "deploy": {
        "startCommand": "pnpm --filter api start",
        "healthcheckPath": "/health",
        "healthcheckTimeout": 30
      },
      "networking": {
        "tcpProxies": {},
        "servicePort": 3001
      },
      "variables": {
        "NODE_ENV": "production",
        "PORT": "3001",
        "DATABASE_URL": "${{Postgres.DATABASE_URL}}",
        "REDIS_URL": "${{Redis.REDIS_URL}}"
      }
    },
    "web": {
      "source": {
        "repo": null
      },
      "build": {
        "builder": "NIXPACKS",
        "buildCommand": "pnpm install && pnpm --filter web build",
        "watchPatterns": ["apps/web/**", "packages/**"]
      },
      "deploy": {
        "startCommand": "pnpm --filter web start"
      },
      "networking": {
        "tcpProxies": {},
        "servicePort": 3000
      },
      "variables": {
        "NODE_ENV": "production",
        "PORT": "3000",
        "NEXT_PUBLIC_API_URL": "${{api.RAILWAY_PUBLIC_DOMAIN}}"
      }
    },
    "Postgres": {
      "source": {
        "image": "postgres:16-alpine"
      },
      "deploy": {
        "startCommand": null
      },
      "networking": {
        "tcpProxies": {
          "5432": "5432"
        }
      },
      "variables": {
        "POSTGRES_USER": "vibetrader",
        "POSTGRES_PASSWORD": "${{secret(32)}}",
        "POSTGRES_DB": "vibetrader",
        "DATABASE_URL": "postgresql://${{POSTGRES_USER}}:${{POSTGRES_PASSWORD}}@${{RAILWAY_PRIVATE_DOMAIN}}:5432/${{POSTGRES_DB}}"
      },
      "volumes": {
        "postgres_data": "/var/lib/postgresql/data"
      }
    },
    "Redis": {
      "source": {
        "image": "redis:7-alpine"
      },
      "deploy": {
        "startCommand": "redis-server --appendonly yes"
      },
      "networking": {
        "tcpProxies": {
          "6379": "6379"
        }
      },
      "variables": {
        "REDIS_URL": "redis://${{RAILWAY_PRIVATE_DOMAIN}}:6379"
      },
      "volumes": {
        "redis_data": "/data"
      }
    }
  }
}
